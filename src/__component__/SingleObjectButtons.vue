<template>
  <div class="singleObjectButton">
    <ButtonGroup
      :data-array="dataArray"
      class="buttonGroup"
      @buttonClick="buttonClick"
    />
    <Dialog 
      ref="dialogRef"
      :title="dialogConfig.title"
      :mask="dialogConfig.mask"
      :content-text="dialogConfig.contentText"
      :footer-hide="dialogConfig.footerHide"
      :confirm="dialogConfig.confirm"
    />
  </div>
</template>

<script>
  // import { mapState } from 'vuex';
  import { mapActions, mapMutations } from 'vuex';
  import buttonmap from '../assets/js/buttonmap';
  import ButtonGroup from './ButtonComponent';
  import moduleName from '../__utils__/getModuleName';
  import router from '../__config__/router.config';
  import Dialog from './Dialog.vue';
  

  export default {
    data() {
      return {
        dialogConfig: {
          title: 'ÊèêÁ§∫',
          mask: true,
          footerHide: false,
          contentText: '',
          confirm: () => {
          }
        },
        
        dataArray: {
          refresh: true, // ÊòæÁ§∫Âà∑Êñ∞
          back: true, // ÊòæÁ§∫Âà∑Êñ∞
          printValue: false, // ÊòØÂê¶ÊòæÁ§∫ÊâìÂç∞
          actionCollection: false,
          collectiImg: false, // ÊòØÂê¶Êî∂Ëóè
          waListButtonsConfig: {// Ëá™ÂÆö‰πâÊåâÈíÆ
            waListButtons: []
          },
          buttonGroupShowConfig: {// Ê†áÂáÜÊåâÈíÆ
            buttonGroupShow: []
          },
          btnclick: (type, item) => {
            const self = this;
            return self.buttonClick(type, item);
          }
        },
        tableName: '', // ‰∏ªË°®Ë°®Âêç
        tableId: '', // ‰∏ªË°®ID
        itemId: '', // Â≠êË°®ID
        currentParameter: {},
        buttonShowType: '', // Âà§Êñ≠ÊåâÈíÆÊòæÁ§∫Êù°‰ª∂
        dynamic: {
          name: '‰øùÂ≠ò',
          icon: '',
          defbutton: 'N',
          action: '',
        }// ‰øùÂ≠òurl
      };
    },
    name: 'SingleObjectButtons',
    components: {
      ButtonGroup,
      Dialog
    },
    watch: {
      tabcmd: {
        handler(val) {
          this.dataArray.buttonGroupShowConfig.buttonGroupShow = [];
          if (this.objectType === 'horizontal') { // Ê®™ÂêëÂ∏ÉÂ±Ä
           
          } else if (this.objectType === 'vertical') {
            // if (this.buttonShowType === 'add') { // ÁºñËæëÊñ∞Â¢ûÊåâÈíÆÊ∏≤ÊüìÈÄªËæë
            //   this.addButtonShow(val);
            // } else //ÊöÇÊú™Â§ÑÁêÜÂ∏¶Â≠êË°®ÁöÑÈÄªËæë
            if (this.itemId === '-1') { // ÁºñËæëÊåâÈíÆÊ∏≤ÊüìÈÄªËæë
              this.addButtonShow(val);
            } else if (this.buttonShowType === 'add') { // ÁºñËæëÊñ∞Â¢û
              this.addButtonShow(val);
            } else { // Êñ∞Â¢ûÊåâÈíÆÊ∏≤ÊüìÈÄªËæë
              this.getbuttonGroupData(val);
            }
          }
        },
        deep: true
      },
    },
    computed: {
    
      
    },
    props: {
      tabcmd: {
        type: Object,
        default: () => ({})
      },
      tabwebact: {
        type: Object,
        default: () => ({})
      },
      objectType: {
        type: String,
        default: ''
      },
      itemName: {
        type: String,
        default: ''
      },
      hasTabPanels: {// Áî®Êù•Âà§Êñ≠ÊòØÂê¶ÊúâÂ≠êË°®
        type: Number,
        default: 0
      },
    },
    methods: {
      ...mapActions(moduleName(), ['getQueryListForAg']),
      ...mapMutations('global', ['tabHref']),
      buttonClick(type, obj) {
        if (type === 'fix') {
          this.objectTabAction(obj);
        } else if (type === 'custom') {
          this.webactionClick(type, obj);
        } else if (type === 'Collection') {
          this.clickButtonsCollect();
        } else if (type === 'back') {
          this.clickButtonsBack();
        } else if (type === 'refresh') {
          this.clickButtonsRefresh();
        } else {
          this.searchClickData();
        }
     
        // }, 300);
      },
      objectTabAction(obj) {
        // clearTimeout(window.timer);

        // window.timer = setTimeout(() => {
        switch (obj.eName) {
        case 'actionADD': // Êñ∞Â¢û
          this.objectAdd(obj);
          break;
        case 'actionMODIFY': // ‰øùÂ≠ò
          this.objectSave(obj);
          break;
        case 'actionEXPORT': // ÂØºÂá∫
          this.objectEXPORT();
          break;
        case 'actionGROUPSUBMIT': // ÊâπÈáèÊèê‰∫§
          this.objectGROUPSUBMIT();
          break;
        case 'actionDELETE': // Âà†Èô§
          this.objectTryDelete(obj);
          break;
        case 'actionSUBMIT': // Êèê‰∫§
          this.objectTrySubmit();
          break;
        case 'actionUNSUBMIT': // ÂèñÊ∂àÊèê‰∫§
          this.objectTryUnSubmit();
          break;
        case 'actionVOID': // ‰ΩúÂ∫ü
          this.objectTryVoid();
          break;
        case 'actionCANCOPY': // Â§çÂà∂
          this.copyFlag = true;
          this.objectCopy();

          break;
        case 'actionCopyBill':
          this.objectCopyBill();
          break;
        default:
          break;
        }
      },
    
      clickButtonsBack() {
        const { tableId, tableName, itemId } = this.$route.params;
        const param = {
          tableId,
          tableName,
          back: true,
        };
        
        this.$store.commit('global/tabHref', param);
        this.getObjectTabForMainTable({ table: tableName, objid: itemId });
        this.getObjectForMainTableForm({ table: tableName, objid: itemId });
      },
      getbuttonGroupData(tabcmd) {
        const tabcmdData = tabcmd;
        // if (this.itemId === '-1') { // Êñ∞Â¢û
        //   this.addButtonShow(tabcmd);
        // } else { // ÂèåÂáª
        if (tabcmdData.cmds) {
          tabcmdData.cmds.forEach((item, index) => {
            if (tabcmdData.prem[index]) {
              const type = item.split('action');
              const str = `CMD_${type[1].toUpperCase()}`;
              if (str === 'CMD_PRINT') {
                this.dataArray.printValue = true;
              } else {
                const buttonConfigInfo = this.buttonMap[str];
                this.buttonMap[str].eName = item;
                buttonConfigInfo.requestUrlPath = tabcmd.paths[index];
                this.dataArray.buttonGroupShowConfig.buttonGroupShow.push(buttonConfigInfo);
              }
            }
          });
        }
        // }
      },
      addButtonShow(tabcmd) { // Âà§Êñ≠ÊåâÈíÆÊòæÁ§∫ÁöÑÊù°‰ª∂ÊòØÂê¶‰∏∫Êñ∞Â¢û
        tabcmd.cmds.forEach((item, index) => {
          if (item === 'actionADD') {
            if (tabcmd.prem[index]) {
              if (item === 'actionADD') {
                this.dynamic.editTheNewId = '-1';// ÁºñËæëÊñ∞Â¢ûÊ†áËØÜ
                this.dynamic.eName = 'actionMODIFY';
                this.dataArray.refresh = false;
                this.dataArray.buttonGroupShowConfig.buttonGroupShow = [];
                this.dynamic.requestUrlPath = this.tabcmd.paths[index];
                this.dataArray.buttonGroupShowConfig.buttonGroupShow.push(this.dynamic);
              }
            
              console.log('üçÉ', this.dynamic);
            }
          }
        });
        // const name = 'actionADD';
        // const type = name.split('action');
        // const str = `CMD_${type[1].toUpperCase()}`;
        // const buttonConfigInfo = this.buttonMap[str];

        // this.buttonMap[str].eName = name;
        // this.dataArray.refresh = false;
        // this.dataArray.buttonGroupShowConfig.buttonGroupShow = [];
        // this.buttonMap[str].editTheNewId = '-1';// ÁºñËæëÊñ∞Â¢ûÊ†áËØÜ

        // // buttonConfigInfo.requestUrlPath = this.tabcmd.paths[index];
        // this.dataArray.buttonGroupShowConfig.buttonGroupShow.push(buttonConfigInfo);
      },
      objectTryDelete(obj) { // Âà†Èô§
        if (this.hasTabPanels !== 0) { // Â≠òÂú®Â≠êË°®
          if (this.dynamicUrl) { // Êúâpath
                
          } else { // Ê≤°Êúâpath
          }
        } else if (obj.requestUrlPath) { // ÊúâpathÔºåÊ≤°ÊúâÂ≠êË°®
          console.log('Êúâpath', obj.requestUrlPath);
          this.$refs.dialogRef.open();
          this.dialogConfig = {
            contentText: 'Á°ÆËÆ§ÊâßË°åÊúâpathÁöÑÂà†Èô§?',
            confirm: () => {
              this.performMainTableDeleteAction({ path: obj.requestUrlPath, table: this.tableName, objId: this.itemId });
              this.$Message.success('Âà†Èô§ÊàêÂäü');
              this.clickButtonsBack();
              const searchData = {
                table: this.tableName,
                startIndex: 0,
                range: 10
              };
              this.getQueryListForAg(searchData);
            }
          };
        } else {
          // Ê≤°Êúâpath
          this.$refs.dialogRef.open();
          this.dialogConfig = {
            contentText: 'Á°ÆËÆ§ÊâßË°åÂà†Èô§?',
            confirm: () => {
              this.performMainTableDeleteAction({ table: this.tableName, objId: this.itemId });
              this.$Message.success('Âà†Èô§ÊàêÂäü');
              this.clickButtonsBack();
              const searchData = {
                table: this.tableName,
                startIndex: 0,
                range: 10
              };
              this.getQueryListForAg(searchData);
              alert(1);
            }
          };
        }
      },

      objectAdd(obj) { // Êñ∞Â¢û
        const id = -1;
        const label = `${obj.name}ÁºñËæë`;
        if (this.objectType === 'horizontal') {
          const type = 'tableDetailHorizontal';
          this.tabHref({
            type,
            tableName: this.tableName,
            tableId: this.tableId,
            label,
            id
          });
        } else if (this.objectType === 'vertical') {
          const type = 'tableDetailVertical';
          this.tabHref({
            type,
            tableName: this.tableName,
            tableId: this.tableId,
            label,
            id
          });
        }
        this.getObjectTabForMainTable({ table: this.tableName, objid: -1 });
        this.getObjectForMainTableForm({ table: this.tableName, objid: -1 });
        this.buttonShowType = 'add';
      },
      objectSave() { // ÊåâÈíÆ‰øùÂ≠òÊìç‰Ωú
        switch (this.objectType) { // Âà§Êñ≠ÊòØÊ®™ÂêëÂ∏ÉÂ±ÄËøòÊòØÁ∫µÂêëÂ∏ÉÂ±Ä
        case 'horizontal': // Ê®™ÂêëÂ∏ÉÂ±Ä
          this.horizontal();
          break;
        case 'vertical': // Á∫µÂêëÂ∏ÉÂ±Ä
          this.vertical();
          break;
        default:
          break;
        }
      },
      horizontal() {
        this.determineSaveType();
      }, // Ê®™ÂêëÂ∏ÉÂ±ÄÔºåÁî®Êù•Âå∫ÂàÜËé∑ÂèñÁöÑÂèÇÊï∞
      vertical() {
        this.determineSaveType();
      }, // Á∫µÂêëÂ∏ÉÂ±Ä
      determineSaveType(obj) {
        // this.getdynamicRequestUrl(this.dataArray.buttonGroupShowConfig.buttonGroupShow);
        this.saveParameters();// Ë∞ÉÁî®Ëé∑ÂèñÂèÇÊï∞ÊñπÊ≥ï
        if (this.itemId === '-1') { // ‰∏ªË°®Êñ∞Â¢û‰øùÂ≠ò
          // console.log('‰∏ªË°®Êñ∞Â¢û‰øùÂ≠ò');
          if (this.hasTabPanels === 0) { // ‰∏∫0ÁöÑÊÉÖÂÜµ‰∏ãÊòØÊ≤°ÊúâÂ≠êË°®
            // console.log('Ê≤°ÊúâÂ≠êË°®');
            const path = this.dynamic.requestUrlPath;
            if (this.dynamic.requestUrlPath) { // ÈÖçÁΩÆpath
              console.log(' ‰∏ªË°®Êñ∞Â¢û‰øùÂ≠ò,ÈÖçÁΩÆpathÁöÑ', this.dynamic.requestUrlPath);
              // const objId = -1;
              this.savaNewTable(path);
            } else { // Ê≤°ÊúâÈÖçÁΩÆpath
              const objId = -1;
              this.savaNewTable(path, objId);
            }
          }
          if (this.hasTabPanels > 0) { // Â§ß‰∫é0 ÁöÑÊÉÖÂÜµ‰∏ãÊòØÂ≠òÂú®Â≠êË°®
            // console.log('ÊúâÂ≠êË°®');
            if (obj.requestUrlPath) { // ÈÖçÁΩÆpath
              // console.log('ÈÖçÁΩÆpathÁöÑÈÄªËæëÊöÇÊó†Ê∑ªÂä†');
            } else { // Ê≤°ÊúâÈÖçÁΩÆpath

            }
          }
        } else if (this.itemId !== '-1') { // ‰∏ªË°®ÁºñËæë‰øùÂ≠ò
          if (this.dynamic.editTheNewId === '-1') { // ÁºñËæëÊñ∞Â¢û‰øùÂ≠ò
            // console.log('ÁºñËæëÊñ∞Â¢û‰øùÂ≠ò');
            if (this.hasTabPanels === 0) { // ‰∏∫0ÁöÑÊÉÖÂÜµ‰∏ãÊòØÊ≤°ÊúâÂ≠êË°®
              console.log('Ê≤°ÊúâÂ≠êË°®', this.dynamic.requestUrlPath);
              const path = this.dynamic.requestUrlPath;

              if (this.dynamic.requestUrlPath) { // ÈÖçÁΩÆpath
                console.log('ÁºñËæëÊñ∞Â¢û‰øùÂ≠ò,ÈÖçÁΩÆpathÁöÑÈÄªËæë');
                this.savaNewTable(path);
              } else { // Ê≤°ÊúâÈÖçÁΩÆpath
                const objId = -1;
                this.savaNewTable(path, objId);
              }
            }
            if (this.hasTabPanels > 0) { // Â§ß‰∫é0 ÁöÑÊÉÖÂÜµ‰∏ãÊòØÂ≠òÂú®Â≠êË°®
              // console.log('ÊúâÂ≠êË°®');
              if (obj.requestUrlPath) { // ÈÖçÁΩÆpath
                     
              } else { // Ê≤°ÊúâÈÖçÁΩÆpath
              
              }
            }
          } else {
            // console.log('‰∏ªË°®ÁºñËæë‰øùÂ≠ò');
            if (this.hasTabPanels === 0) { // ‰∏∫0ÁöÑÊÉÖÂÜµ‰∏ãÊòØÊ≤°ÊúâÂ≠êË°®
              // console.log('Ê≤°ÊúâÂ≠êË°®', this.dynamicUrl);
              const path = this.dynamicUrl;

              if (obj.requestUrlPath) { // ÈÖçÁΩÆpath
                console.log('‰∏ªË°®ÁºñËæë‰øùÂ≠ò,ÈÖçÁΩÆpathÁöÑÈÄªËæë');
                this.savaNewTable(path);
              } else { // Ê≤°ÊúâÈÖçÁΩÆpath
                const objId = this.itemId;
                this.savaNewTable(path, objId);
              }
            }
            if (this.hasTabPanels > 0) { // Â§ß‰∫é0 ÁöÑÊÉÖÂÜµ‰∏ãÊòØÂ≠òÂú®Â≠êË°®
              // console.log('ÊúâÂ≠êË°®');
              if (obj.requestUrlPath) { // ÈÖçÁΩÆpath
                // console.log('ÈÖçÁΩÆpathÁöÑÈÄªËæëÊöÇÊó†Ê∑ªÂä†');
              } else { // Ê≤°ÊúâÈÖçÁΩÆpath

              }
            }
          }
        } 
      },
      savaNewTable(path, objId) { // ‰∏ªË°®Êñ∞Â¢û‰øùÂ≠òÊñπÊ≥ï
        const tableName = this.tableName;
        const parame = {
          ...this.currentParameter,
          tableName,
          objId,
          path
        };
        this.performMainTableSaveAction(parame);
        // if (this.info) {
        // clearTimeout(window.timer);
        // if (this.objectType === 'horizontal') { // Ê®™ÂêëÂ∏ÉÂ±Ä
        //   if (this.newMainTableSaveData.code === 0) {
        // console.log('ÊöÇÊó†Ê∑ªÂä†Ê®™ÂêëÂ∏ÉÂ±ÄÊúâpathÁöÑÈÄªËæë');// Êúâpath
        // const itemId = this.mainFormInfo.buttonsData.newMainTableSaveData.objId;// ‰øùÂ≠òÊé•Âè£ËøîÂõûÁöÑÊòéÁªÜid
        // this.getObjectTabForMainTable({ table: tableName, objid: itemId });
        // this.getObjectForMainTableForm({ table: tableName, objid: itemId });
        // }
        // } else {
        setTimeout(() => {
          const itemId = this.mainFormInfo.buttonsData.newMainTableSaveData.objId;// ‰øùÂ≠òÊé•Âè£ËøîÂõûÁöÑÊòéÁªÜid
          this.getObjectTabForMainTable({ table: tableName, objid: itemId });
          this.getObjectForMainTableForm({ table: tableName, objid: itemId });
        }, 1000);
        // }
      
     
        // }
      },
      saveParameters() {
        if (this.itemName) { // ÊúâÂ≠êË°®
          Object.keys(this.updateData).reduce((obj, current) => { // Ëé∑ÂèñstoreÂÇ®Â≠òÁöÑÊñ∞Â¢û‰øÆÊîπ‰øùÂ≠òÈúÄË¶ÅÁöÑÂèÇÊï∞‰ø°ÊÅØ
            if (current === this.itemName) {
              this.currentParameter = this.updateData[current];
            }
            return obj;
          }, {});
        } else { // Ê≤°ÊúâÂ≠êË°®
          Object.keys(this.updateData).reduce((obj, current) => { // Ëé∑ÂèñstoreÂÇ®Â≠òÁöÑÊñ∞Â¢û‰øÆÊîπ‰øùÂ≠òÈúÄË¶ÅÁöÑÂèÇÊï∞‰ø°ÊÅØ
            if (current === this.tableName) {
              this.currentParameter = this.updateData[current];
            }
            return obj;
          }, {});
        }
      }
    },
    mounted() {
      this.getbuttonGroupData(this.tabcmd);
    },
    created() {
      const { tableName, tableId, itemId } = router.currentRoute.params;
      this.tableName = tableName;
      this.tableId = tableId;
      this.itemId = itemId;
      this.buttonMap = buttonmap;
    }
  };
</script>

<style lang="less">
.singleObjectButton {
  .buttonGroup {
    padding: 10px 20px 5px 20px;
  }
}
</style>
